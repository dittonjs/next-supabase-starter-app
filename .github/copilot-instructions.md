# Copilot Instructions for Next.js + Supabase Starter

## Architecture Overview

This is a **Next.js 15+ with App Router** starter kit integrated with **Supabase Auth** using the `@supabase/ssr` package for cookie-based session management. Sessions are available across Client Components, Server Components, Route Handlers, and Server Actions.

### Key Architecture Patterns

- **Authentication Layer**: Supabase handles all auth (password, OTP, OAuth). Session state managed via cookies, not client-side state.
- **Dual Supabase Clients**:
  - `lib/supabase/client.ts`: Browser client for Client Components (`"use client"`)
  - `lib/supabase/server.ts`: Server client for Server Components and Route Handlers
- **UI Components**: Built with `shadcn/ui` (Radix UI primitives) + Tailwind CSS
- **Protected Routes**: `app/protected/` layout checks auth status via Server Component `AuthButton`

## Critical Developer Workflows

### Local Development
```bash
npm run dev       # Start Next.js dev server on localhost:3000
npm run build     # Verify production build
npm run lint      # Run ESLint (required before commits)
```

### Environment Setup
Create `.env.local` with:
```
NEXT_PUBLIC_SUPABASE_URL=<your-project-url>
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=<your-publishable-key>
```
Both are required and public (NEXT_PUBLIC_ prefix). Find them in Supabase dashboard > Project Settings > API.

### Database & Supabase
- No local Supabase setup required by default, but `supabase` CLI is in devDeps
- See README for local development with `supabase start` if needed
- Database changes only through Supabase dashboard or migrations

## Code Patterns & Conventions

### 1. Protected Server Pages & Components
For pages that require authentication, use `requireAuth()` from `lib/auth.ts`:
```typescript
// app/dashboard/page.tsx - Protected page pattern
import { requireAuth } from "@/lib/auth";

export default async function DashboardPage() {
  const user = await requireAuth();  // Auto-redirects to /auth/login if not authenticated
  
  return <div>Welcome, {user.email}</div>;
}
```

To check auth status without redirecting (e.g., for conditional UI):
```typescript
// app/protected/layout.tsx pattern
import { createClient } from "@/lib/supabase/server";

export async function AuthButton() {
  const supabase = await createClient();
  const { data } = await supabase.auth.getClaims();  // Server-safe auth check
  const user = data?.claims;
  
  return user ? <LogoutButton /> : <LoginButton />;
}
```

### 2. Authentication in Client Components
Use `useAuth()` hook from `hooks/use-auth.ts` for client-side auth state:
```typescript
// Client Component pattern - "use client" required
"use client";
import { useAuth } from "@/hooks/use-auth";

export function ProfileCard() {
  const { user, loading } = useAuth();  // Real-time auth state
  
  if (loading) return <div>Loading...</div>;
  if (!user) return <div>Not authenticated</div>;
  
  return <div>Hello, {user.email}</div>;
}
```

For client-side auth actions (login, signup), use the **browser client**:
```typescript
// components/login-form.tsx pattern - "use client" required
import { createClient } from "@/lib/supabase/client";

export function LoginForm() {
  const handleLogin = async (e: React.FormEvent) => {
    const supabase = createClient();
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;
    router.push("/protected");  // useRouter from next/navigation
  };
}
```

### 3. Auth Routes (Route Handlers)
Located in `app/auth/*/route.ts`. Key pattern for OTP confirmation:
```typescript
// app/auth/confirm/route.ts
const { data } = await supabase.auth.verifyOtp({ type, token_hash });
if (!error) redirect(next);  // Post-auth redirect
else redirect(`/auth/error?error=${error.message}`);
```

### 4. Styling with Tailwind + shadcn/ui
- All components use Tailwind CSS with CSS variables (see `components.json` baseColor: "neutral")
- Import UI components from `@/components/ui/*` (auto-generated by shadcn)
- Use `cn()` helper from `lib/utils.ts` to merge Tailwind classes safely
- Theme switching via `next-themes` (see `app/layout.tsx` ThemeProvider)

### 5. TypeScript Configuration
- Strict mode enabled (`"strict": true` in tsconfig.json)
- Path alias `@/*` maps to root directory for cleaner imports
- Use `import { type Foo }` for type-only imports to avoid bundling

## File Organization & Key Directories

| Path | Purpose |
|------|---------|
| `app/` | Next.js App Router pages & layouts |
| `app/auth/` | Authentication routes (login, sign-up, confirm, errors) |
| `app/protected/` | Requires auth; uses `AuthButton` to check session |
| `components/` | React components (auth forms, UI, layouts) |
| `components/ui/` | shadcn/ui generated components (auto-imported) |
| `lib/auth.ts` | Auth utilities (`requireAuth()` for protected pages) |
| `lib/supabase/` | Supabase client factories (client.ts, server.ts) |
| `lib/utils.ts` | Utilities (cn() for Tailwind merging) |
| `hooks/use-auth.ts` | Client-side auth hook for real-time user state |

## Integration Points & Dependencies

- **@supabase/ssr**: Handles cookie-based session across Next.js layers
- **@supabase/supabase-js**: Core client SDK
- **next-themes**: Dark/light theme management
- **shadcn/ui**: Pre-built React components on Radix UI
- **Tailwind CSS**: Utility-first CSS framework
- **ESLint + TypeScript**: Strict code quality

## Important Implementation Details

### Server Client Caveat
In `lib/supabase/server.ts`, the comment warns: *"Don't put this client in a global variable. Always create a new client within each function when using it."* This is critical for Vercel Functionsâ€”create fresh instances per request.

### Public vs Private Keys
- `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`: Safe for browser; used in both clients
- No separate private key in env; Supabase handles auth on server via cookies

### Suspense Boundaries
`AuthButton` is wrapped in `<Suspense>` in `app/protected/layout.tsx` because it's an async Server Component. Always wrap async Server Components in Suspense in layouts.

## Common Tasks

**Add a new auth form**: Copy `components/login-form.tsx` pattern (use `createClient()` from `/client`, add `"use client"` directive)

**Add protected page**: Create file in `app/protected/`, it inherits the auth-checking layout

**Add UI component**: Use `npx shadcn-ui@latest add <component>` (reads from `components.json`), then import from `@/components/ui`

**Update auth flow**: Modify route handlers in `app/auth/*/route.ts` or form handlers in `components/*-form.tsx`
